<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>포켓몬 검색기</title>
    <style>
      @font-face {
        font-family: "Simple";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-1@1.1/Danjo-bold-Regular.woff2")
          format("woff2");
        font-weight: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Cafe24-Surround";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/Cafe24Ssurround.woff")
          format("woff");
        font-weight: normal;
        font-display: swap;
      }

      body {
        font-family: "Cafe24-Surround", sans-serif;
      }

      .container {
        max-width: 500px;
        margin: 40px auto;
        padding: 20px;
        border: 1px solid lightgray;
        border-radius: 8px;
        text-align: center;
      }

      input {
        padding: 10px;
        width: 60%;
        margin-right: 10px;
        border: 1px solid gray;
        border-radius: 5px;
      }

      button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        background-color: dodgerblue;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background-color: royalblue;
      }

      #result {
        margin-top: 20px;
      }

      #result h2 {
        margin: 10px 0;
      }

      #result img {
        width: 150px;
        height: 150px;
        background-color: ghostwhite;
        border-radius: 50%;
      }

      .type {
        display: inline-block;
        padding: 5px 10px;
        margin: 5px;
        border-radius: 15px;
        color: white;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>포켓몬 정보 조회</h1>
      <form id="search-form">
        <input
          type="text"
          name="poke-name"
          id="poke-name"
          placeholder="포켓몬 이름을 입력해주세요"
        />
        <button id="search-form-btn">검색</button>
      </form>
      <div id="result">
        <p id="message">검색해보세요!</p>
        <div class="hide" id="poke-info">
          <h2>
            <span id="poke-koname">포켓몬</span> /
            <span id="poke-enname">Pokemon</span>
          </h2>
          <img src="" alt="포켓몬 사진" />
          <div id="poke-types"></div>
        </div>
      </div>
    </div>

    <script>
      async function changeNameToId(name) {
        if (localStorage.getItem("nameToId")) {
          return JSON.parse(localStorage.getItem("nameToId"))[name];
        }
        const pokeLength = 1025;
        const nameToId = {};
        async function fetchPokeKor(id) {
          const koNameResponse = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${id}`
          );
          if (!koNameResponse.ok) throw new Error("존재하지 않는 포켓몬!");
          const koNameData = await koNameResponse.json();
          const { names } = koNameData;
          const koNames = names.filter((x) => x.language.name === "ko");
          const koName = koNames[0].name;
          nameToId[koName] = id;
        }
        const promises = [];
        for (let i = 1; i < pokeLength; i++) {
          promises.push(fetchPokeKor(i));
        }
        await Promise.all(promises);
        localStorage.setItem("nameToId", JSON.stringify(nameToId));
        return nameToId[name];
      }

      async function searchPoke(event) {
        event.preventDefault();
        const name = document.querySelector("#poke-name").value;
        if (!name) {
          alert("포켓몬 이름을 입력해주세요!");
          return;
        }
        await searchName(name);
      }

      async function searchName(name) {
        const pokeNo = await changeNameToId(name);

        const response = await fetch(
          `https://pokeapi.co/api/v2/pokemon/${pokeNo}`
        );
        if (!response.ok) throw new Error("존재하지 않는 포켓몬!");

        const data = await response.json();
        const { sprites } = data;
        const { front_default } = sprites;
        document
          .querySelector("#result img")
          .setAttribute("src", front_default);

        const koNameResponse = await fetch(
          `https://pokeapi.co/api/v2/pokemon-species/${pokeNo}`
        );
        if (!koNameResponse.ok) throw new Error("존재하지 않는 포켓몬!");
        const koNameData = await koNameResponse.json();
        const { names } = koNameData;
        const koNames = names.filter((x) => x.language.name === "ko");
        const koName = koNames[0].name;

        document.querySelector("#poke-koname").textContent = koName;
        document.querySelector("#poke-enname").textContent = data.name;

        // 타입 표시
        const typesHtml = data.types
          .map(
            (typeInfo) =>
              `<span class="type" style="background-color: ${getTypeColor(
                typeInfo.type.name
              )}">${typeInfo.type.name}</span>`
          )
          .join(" ");
        document.querySelector("#poke-types").innerHTML =
          "<h3>타입</h3>" + typesHtml;

        document.querySelector("#poke-info").classList.remove("hide");
        document.querySelector("#message").classList.add("hide");

        localStorage.setItem("memory", name);
      }

      function getTypeColor(type) {
        const colors = {
          fire: "orangered",
          water: "dodgerblue",
          grass: "limegreen",
          bug: "darkkhaki",
          normal: "lightgray",
          poison: "mediumpurple",
          electric: "gold",
          ground: "sandybrown",
          fairy: "lightpink",
          fighting: "indianred",
          psychic: "hotpink",
          rock: "darkgoldenrod",
          ghost: "rebeccapurple",
          ice: "lightcyan",
          dragon: "slateblue",
          steel: "silver",
          dark: "black",
          flying: "skyblue",
        };
        return colors[type] || "gray";
      }

      const searchForm = document.querySelector("#search-form");
      searchForm.addEventListener("submit", searchPoke);

      document.addEventListener("DOMContentLoaded", async () => {
        const memory = localStorage.getItem("memory");
        if (!memory) return;
        await searchName(memory);
        document.querySelector("#poke-name").value = memory;
      });
    </script>
  </body>
</html>
